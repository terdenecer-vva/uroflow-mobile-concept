name: Mobile Build

on:
  workflow_dispatch:
    inputs:
      build_profile:
        description: "EAS build profile"
        required: false
        type: choice
        options:
          - preview
          - development
          - production
        default: preview
      build_platform:
        description: "Target platform"
        required: false
        type: choice
        options:
          - all
          - ios
          - android
        default: all
      wait_for_build:
        description: "Wait until build completes"
        required: false
        type: boolean
        default: false
  push:
    branches:
      - main
    paths:
      - "apps/field-mobile/**"
      - ".github/workflows/mobile-build.yml"

concurrency:
  group: mobile-build-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  preflight:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    defaults:
      run:
        working-directory: apps/field-mobile

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: apps/field-mobile/package.json

      - name: Install dependencies
        run: npm install --no-audit --no-fund

      - name: Typecheck
        run: npm run typecheck

      - name: Build release manifest
        env:
          WORKFLOW_BUILD_PROFILE: ${{ github.event.inputs.build_profile || 'preview' }}
        run: |
          profile="${WORKFLOW_BUILD_PROFILE:-preview}"
          channel="$profile"
          if [[ "$profile" == "development" ]]; then
            channel="development"
          elif [[ "$profile" == "production" ]]; then
            channel="production"
          fi
          python ../../scripts/build_mobile_release_manifest.py \
            --app-json app.json \
            --output /tmp/mobile-release-manifest.json \
            --profile "$profile" \
            --channel "$channel" \
            --model-id fusion-v0.1 \
            --schema-version ios_capture_v1

      - name: Upload release manifest
        uses: actions/upload-artifact@v4
        with:
          name: mobile-release-manifest
          path: /tmp/mobile-release-manifest.json

  eas-build:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    needs: preflight
    if: ${{ github.event_name == 'workflow_dispatch' }}

    defaults:
      run:
        working-directory: apps/field-mobile

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check EXPO_TOKEN availability
        id: expo
        shell: bash
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -z "${EXPO_TOKEN:-}" ]]; then
            echo "available=false" >> "$GITHUB_OUTPUT"
            echo "EXPO_TOKEN is not configured; EAS build steps will be skipped."
          else
            echo "available=true" >> "$GITHUB_OUTPUT"
            echo "EXPO_TOKEN is configured."
          fi

      - name: Set up Node.js
        if: ${{ steps.expo.outputs.available == 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: apps/field-mobile/package.json

      - name: Install dependencies
        if: ${{ steps.expo.outputs.available == 'true' }}
        run: npm install --no-audit --no-fund

      - name: Install EAS CLI
        if: ${{ steps.expo.outputs.available == 'true' }}
        run: npm install -g eas-cli

      - name: Trigger EAS build
        if: ${{ steps.expo.outputs.available == 'true' }}
        id: eas
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          WORKFLOW_BUILD_PROFILE: ${{ github.event.inputs.build_profile || 'preview' }}
          WORKFLOW_BUILD_PLATFORM: ${{ github.event.inputs.build_platform || 'all' }}
          WORKFLOW_WAIT_FOR_BUILD: ${{ github.event.inputs.wait_for_build || 'false' }}
        run: |
          set -euo pipefail
          profile="${WORKFLOW_BUILD_PROFILE:-preview}"
          platform="${WORKFLOW_BUILD_PLATFORM:-all}"
          wait_for_build="${WORKFLOW_WAIT_FOR_BUILD:-false}"

          cmd=(eas build --platform "$platform" --profile "$profile" --non-interactive --json)
          if [[ "$wait_for_build" == "true" ]]; then
            cmd+=(--wait)
          else
            cmd+=(--no-wait)
          fi

          "${cmd[@]}" > /tmp/eas-build-result.json
          echo "result_json=/tmp/eas-build-result.json" >> "$GITHUB_OUTPUT"

      - name: Upload EAS build result artifact
        if: ${{ steps.expo.outputs.available == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: mobile-eas-build-result-${{ github.run_id }}
          path: /tmp/eas-build-result.json
          if-no-files-found: error

      - name: Publish EAS build summary
        if: ${{ steps.expo.outputs.available == 'true' }}
        shell: bash
        env:
          RESULT_JSON: ${{ steps.eas.outputs.result_json }}
          WORKFLOW_BUILD_PROFILE: ${{ github.event.inputs.build_profile || 'preview' }}
          WORKFLOW_BUILD_PLATFORM: ${{ github.event.inputs.build_platform || 'all' }}
          WORKFLOW_WAIT_FOR_BUILD: ${{ github.event.inputs.wait_for_build || 'false' }}
        run: |
          set -euo pipefail
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          result_path = Path(os.environ["RESULT_JSON"])
          payload = json.loads(result_path.read_text(encoding="utf-8"))
          builds = payload if isinstance(payload, list) else [payload]

          lines = [
              "## Mobile EAS Build",
              f"- Profile: `{os.environ.get('WORKFLOW_BUILD_PROFILE', 'preview')}`",
              f"- Platform: `{os.environ.get('WORKFLOW_BUILD_PLATFORM', 'all')}`",
              f"- Wait mode: `{os.environ.get('WORKFLOW_WAIT_FOR_BUILD', 'false')}`",
              f"- Result JSON: `{result_path}`",
              "",
              "### Build Links",
          ]

          if not builds:
              lines.append("- No build records returned by EAS.")
          else:
              for index, item in enumerate(builds, start=1):
                  if not isinstance(item, dict):
                      lines.append(f"- Build {index}: unexpected payload shape")
                      continue
                  platform = item.get("platform", "unknown")
                  build_id = item.get("id", "-")
                  status = item.get("status", "-")
                  web_url = item.get("webUrl") or item.get("artifacts", {}).get("buildUrl")
                  lines.append(
                      f"- `{platform}` build `{build_id}` status `{status}`"
                      + (f" ([open]({web_url}))" if web_url else "")
                  )

          Path(os.environ["GITHUB_STEP_SUMMARY"]).write_text(
              "\n".join(lines) + "\n",
              encoding="utf-8",
          )
          PY

      - name: Publish skip summary
        if: ${{ steps.expo.outputs.available != 'true' }}
        shell: bash
        run: |
          {
            echo "## Mobile EAS Build"
            echo "- Status: \`skipped\`"
            echo "- Reason: \`EXPO_TOKEN is not configured in repository secrets\`"
          } >> "$GITHUB_STEP_SUMMARY"
