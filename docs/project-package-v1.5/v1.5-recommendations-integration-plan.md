# План внедрения рекомендаций из Uroflow Project Package v1.5

Дата: 2026-02-24  
Источник: `Uroflow_Project_Package_v1.5.zip`

## 1. Что нового и зачем это важно

Пакет `v1.5` добавляет слой "исполнения", который закрывает разрыв между R&D и клиническим запуском:

1. QMS в операционном виде (`QMS SOP Pack`, `QMS Forms`, `DHF Index v1.1`).
2. Жесткая синхронизация claims/labeling/UI/IFU (`IntendedUse Claims ByRegion`, `Labeling Claims Alignment`, `Claims-Evidence Matrix`).
3. Конкретные acceptance gates (G0/G1/G2) с числовыми порогами (`Acceptance Criteria`, `Acceptance Test Matrix`).
4. Формализованный golden dataset и аннотация (`Golden Dataset Plan/Schema`, `Annotation SOP QA`, `Dataset Card`).
5. Калибровка Quality Score как safety gate (`QS Calibration Protocol`).
6. Готовый операционный пакет старта пилотной площадки (`Clinical Pilot Site Startup Package`, site logs/checklists).
7. Явный модельный контракт для iOS/CoreML (`CoreML Model Input Contract v1.0`).

## 2. Gap-анализ относительно текущего репозитория

### 2.1 Уже есть (можно развивать, а не переписывать)

- Базовый intended use: `docs/intended-use-v1.md`
- Claims governance (в общем виде): `docs/claims-governance-v0.1.md`
- Pilot-протокол и SAP-логика в черновом объеме: `docs/pilot-protocol-v1.md`, `docs/clinical-protocol-one-pager-v0.1.md`
- ML pipeline foundation и dataset contract: `docs/ml-pipeline-package-v1.0/`
- EDC v1.1, REDCap/OpenClinica профили: `docs/edc-v1.1/`
- Базовый runtime для capture/fusion/quality: `src/uroflow_mobile/`

### 2.2 Частично покрыто (нужна доработка до v1.5)

- Quality status есть (`valid/repeat/reject`), но нет утвержденного calibration loop с целями `False Valid Rate <= 2%` и hard artifact override.
- Есть event/flow pipeline, но нет полного `CoreML Input Contract v1.0` (feature dimensions, Model A/B IO, session JSON contract).
- Есть pilot документы, но нет операционного site-startup комплекта с логами и readiness gate в артефактах проекта.
- Есть risk/claims документы, но нет claims-evidence traceability registry в workflow репозитория.

### 2.3 Отсутствует (нужно добавить)

- Acceptance gates G0/G1/G2 как исполняемые проверки release процесса.
- Regression Suite runner с PASS/FAIL по порогам (`Qmax_MAE`, `Vvoid_MAPE`, `Valid_Rate_Min`, `Quality_Min`).
- Golden dataset schema validators (manifest/file-structure/QA checks).
- Annotation QA automation (double-annotation thresholds, adjudication queue).
- QMS operational registers и связка с change-control pipeline (CR/CAPA/Complaint/PMS).

## 3. Как использовать рекомендации v1.5 в коде и процессах

## 3.1 Acceptance Criteria + Test Matrix -> Release Gates

Использование:
- Превратить таблицы G0/G1/G2 в машинно-проверяемые конфиги порогов.
- Привязать к CI и release decision.

Внедрение:
- Добавить модуль `src/uroflow_mobile/gates.py`.
- Добавить команду `uroflow-mobile evaluate-gates --metrics <json>`.
- Добавить шаблон входного `metrics.json` для pilot/pivotal/bench.

DoD:
- Команда возвращает `PASS/FAIL` по G0/G1/G2 и список нарушенных критериев.

## 3.2 CoreML Input Contract -> Технический runtime-контракт

Использование:
- Зафиксировать единый формат feature frames (100 мс, 10 Гц): `x_audio[80]`, `x_video[32]`, `x_geom[16]`, `x_imu[8]`.
- Разделить inference на `Model A` (event/quality/artifacts) и `Model B` (Q + sigma).

Внедрение:
- Добавить контрактные dataclass/validators: `src/uroflow_mobile/contracts/coreml_v1.py`.
- Добавить сериализацию результата сессии в формате `contract_version/modelA_id/modelB_id/series/summary/quality`.
- Добавить regression tests на совместимость контракта.

DoD:
- Любой session output валиден против JSON schema `contract_version=1.0`.

## 3.3 Golden Dataset Plan/Schema -> DataOps foundation

Использование:
- Ввести canonical `manifest` и QA checks как обязательные перед train/eval.
- Применять `subject-wise split` + `LOTO` + holdout "new toilet".

Внедрение:
- Добавить `scripts/validate_golden_manifest_v1_0.py`.
- Добавить `scripts/build_splits_v1_0.py` (subject-wise, LOTO, site/device holdout).
- Добавить `docs/datasets/golden-dataset-card-template.md` (экспорт из DOCX шаблона в md).

DoD:
- Ни один train run не стартует без `manifest QA = PASS`.

## 3.4 Annotation SOP + QS Calibration -> Safety gate

Использование:
- Принять SOP-пороги как стандарт разметки (`FlowThreshold=0.5`, `StartHold=0.3s`, `EndHold=1.0s`).
- Калибровать QS с целевой метрикой `False Valid Rate <= 2%`.
- Ввести hard override: `flush/not_in_water/roi_lost -> invalid`.

Внедрение:
- Добавить `scripts/calibrate_quality_thresholds.py`.
- Добавить `scripts/evaluate_annotation_agreement.py` (|Δt_start|, |Δt_end|, kappa).
- Обновить `src/uroflow_mobile/session.py`: отдельный блок artifact hard-invalid rules.

DoD:
- Отчет калибровки QS автоматически генерируется и хранит выбранные `QS_VALID/QS_BORDERLINE` + версии `dataset_id/model_id`.

## 3.5 QMS SOP/Registers + DHF Index -> Управление изменениями

Использование:
- Сделать QMS-реестры частью release workflow, а не внешним приложением.
- Любое изменение модели/claims/порогов только через CR + regression + risk update.

Внедрение:
- Добавить папку `qms/` с CSV/JSON реестрами (export из xlsx шаблонов).
- Добавить `scripts/qms_open_actions_report.py` и `scripts/qms_release_check.py`.
- Связать release чеклист с `DHF Index` и `Open Actions`.

DoD:
- Релиз блокируется, если есть незакрытые high-priority action items или непройденный regression suite.

## 3.6 Labeling/Claims alignment -> Продуктовые тексты без регриска

Использование:
- Централизовать утвержденные формулировки (UI/PDF/Store/IFU).
- Ввести lint для запрещенных claims.

Внедрение:
- Добавить `docs/claims/approved_phrase_library_v1.csv`.
- Добавить `scripts/lint_claims_texts.py` (по паттернам запрета).
- Добавить release-проверку: UI/report texts соответствуют Claim Set A.

DoD:
- Перед релизом есть auto-report `claims_alignment=PASS`.

## 3.7 Clinical pilot site startup -> Операционное включение клиники

Использование:
- Применить site readiness gate как входной критерий пилота.

Внедрение:
- Добавить `docs/clinical-site-startup/` с markdown-версиями:
  - ethics checklist,
  - recruitment script,
  - site initiation agenda,
  - logs templates.
- Добавить `scripts/site_readiness_check.py`.

DoD:
- Площадка получает статус `READY` только при полном чеклисте (IRB, training, dry-runs, data export, privacy checks).

## 4. Поэтапный план внедрения (12 недель)

## Этап 0 (Неделя 1): Freeze scope

Задачи:
- Зафиксировать Claim Set A как единственный стартовый набор.
- Зафиксировать G0/G1/G2 пороги в репозитории.
- Утвердить owner-матрицу (RA/QA, SW, Clinical, Data, Security).

Выход:
- `scope-freeze.md`, `gates-config-v1.json`, `owners-raci-v1.csv`.

## Этап 1 (Недели 2-3): Data/QS foundation

Задачи:
- Внедрить golden manifest validator и split builder.
- Внедрить annotation agreement и QS calibration scripts.
- Сформировать первый frozen regression set.

Выход:
- `dataset_id=v1.0-freeze-candidate`,
- `qs_calibration_report_v1.pdf/md`,
- `regression_set_v1`.

## Этап 2 (Недели 4-6): Runtime contract + metrics gates

Задачи:
- Реализовать CoreML contract layer (`contract_version=1.0`).
- Привести session output к контрактному JSON.
- Добавить gate evaluator и CI job `release-gates`.

Выход:
- Контрактные unit/integration tests,
- `release-gates` отчет с PASS/FAIL.

## Этап 3 (Недели 7-9): QMS operationalization

Задачи:
- Перенести QMS registers в машиночитаемый контур.
- Внедрить release blockers: open high actions, CAPA unresolved, missing CR.
- Подготовить claims lint + phrase library.

Выход:
- `qms_status_report` на каждый релиз.

## Этап 4 (Недели 10-12): Pilot readiness

Задачи:
- Собрать site startup package в рабочем формате.
- Провести 2-3 dry-run с end-to-end data flow.
- Закрыть open actions A-001..A-006 из DHF.

Выход:
- Pilot go/no-go packet,
- `site_readiness=READY`.

## 5. Критические зависимости и риски

1. Неопределенные owners/approvers в DHF: блокирует формальное QMS.
2. Отсутствие референс-экспорта Q_ref(t) на выбранной площадке: блокирует golden dataset.
3. Неутвержденная data residency политика по регионам: блокирует сбор сырого media.
4. Нефиксированные QS пороги: высокий риск ложной валидности.
5. Расхождение claims между UI/IFU/store: высокий регуляторный риск.

## 6. Приоритеты на ближайшие 10 рабочих дней

1. Зафиксировать `Acceptance Criteria` и `Acceptance Test Matrix` как executable конфиг в репозитории.
2. Реализовать `validate_golden_manifest` + `build_splits (LOTO)`.
3. Реализовать `calibrate_quality_thresholds` и hard-invalid artifact rules.
4. Формализовать session JSON по `CoreML Contract v1.0`.
5. Ввести минимальный `qms_release_check` (CR + regression + open actions).

## 7. Рекомендуемая структура задач (Linear/Epic)

- EPIC-01: `Measurement Contract & Runtime`
- EPIC-02: `Golden Dataset & Annotation QA`
- EPIC-03: `Quality Score Calibration & Safety Gates`
- EPIC-04: `QMS Operational Registers & Release Control`
- EPIC-05: `Claims/Labeling Alignment`
- EPIC-06: `Pilot Site Startup`

