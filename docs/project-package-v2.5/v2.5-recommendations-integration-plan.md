# План интеграции Uroflow Project Package v2.5

Дата: 2026-02-24  
Источник: `Uroflow_Project_Package_v2.5.zip`

## 1. Что добавляет v2.5

Ключевое отличие от `v1.5`: пакет ориентирован на **submission-ready execution** и добавляет полноценный блок `10_Pilot_Automation`:

1. Автоматический daily QA для golden dataset.
2. Автоматическая генерация TFL по сравнению `Q_pred/Q_ref`.
3. Drift dashboard по стратификациям (`site_id`, `toilet_id`, `iphone_model`, `noise_level`, `sex`, `posture`).
4. Сборщик G1 evidence bundle с проверкой порогов.
5. Обновлённые master indexes для EU/US submission готовности.

## 2. Что уже интегрировано в репозиторий

### 2.1 Инвентаризация и извлечение структуры v2.5

Сформированы артефакты:

- `docs/project-package-v2.5/package_manifest_v2.5.csv`
- `docs/project-package-v2.5/module_summary_v2.5.csv`
- `docs/project-package-v2.5/docx_inventory_v2.5.csv`
- `docs/project-package-v2.5/xlsx_sheet_inventory_v2.5.csv`
- `docs/project-package-v2.5/sheets/` (извлечённые ключевые листы XLSX)
- `docs/project-package-v2.5/source_readme_v2.5.txt`

Итоги инвентаризации:

- всего файлов: **352**
- DOCX: **133**
- XLSX: **70**
- выделен отдельный automation-пакет для исполняемого QA/TFL/Drift/G1.

### 2.2 Импорт pilot automation v2.5

Скрипты и конфиги вынесены в:

- `scripts/pilot_automation_v2_5/`

Импортировано:

- `scripts/` (daily QA, TFL, drift, G1 bundle, checksum/manifest utils),
- `config/` (QA, metrics, G1 thresholds),
- `schemas/`,
- one-click launcher scripts и README.

### 2.3 Исправления совместимости при интеграции

1. Обновлена численная интеграция для `numpy>=2.x`:
   - `scripts/pilot_automation_v2_5/scripts/uroflow_qa_utils.py`
   - `scripts/pilot_automation_v2_5/scripts/run_tfl_from_golden_dataset.py`
   - заменён `np.trapz` на `np.trapezoid` (с fallback).
2. Исправлен unit mismatch в G1-пороге:
   - `scripts/pilot_automation_v2_5/config/g1_acceptance_config.json`
   - `mape_vvoid_max: 0.15 -> 15.0` (в скрипте MAPE считается в процентах).
3. Внешний пакет automation помечен как vendor для линтинга:
   - `pyproject.toml` (`ruff.extend-exclude = ["scripts/pilot_automation_v2_5/scripts"]`)
   - это исключает массовые stylistic-ошибки из импортированного внешнего кода, не затрагивая продуктовые модули.

### 2.4 Gate-конфиг по порогам v2.5

Добавлен отдельный gate-конфиг:

- `docs/project-package-v2.5/gates-config-v2.5.json`

Он отражает пороги из `Uroflow_Acceptance_Test_Matrix_v1.0` (clinical + bench) и может быть
напрямую использован в `uroflow-mobile evaluate-gates`.

## 3. Результаты smoke-проверки automation v2.5

Прогоны выполнены на `sample_dataset_v1.1` из пакета v2.5.

Артефакты smoke-результатов:

- `docs/project-package-v2.5/automation_smoke/2026-02-24/qa_summary.json`
- `docs/project-package-v2.5/automation_smoke/2026-02-24/daily_qa_report.xlsx`
- `docs/project-package-v2.5/automation_smoke/tfl/tfl_record_level.csv`
- `docs/project-package-v2.5/automation_smoke/drift/drift_summary.json`
- `docs/project-package-v2.5/automation_smoke/g1/g1_eval.json`
- `docs/project-package-v2.5/automation_smoke/g1/G1_Evidence_Summary.xlsx`

Краткий результат:

- Daily QA: все 24 записи прошли record-level проверки (`n_fail=0`).
- G1 eval: после правки MAPE-порога проходит 4/5 метрик; не проходит `valid_rate` (0.75 < 0.85), что соответствует test dataset.
- Репозиторий после интеграции: `ruff check .` и `pytest -q` проходят (`51 passed`).

## 4. Влияние на текущую кодовую базу

Интеграция v2.5 хорошо стыкуется с уже внедрёнными изменениями API/mobile:

1. `Clinical Hub` уже поддерживает audit trail и role/operator/site/request headers.
2. Мобильный клиент уже поддерживает offline queue и повторную синхронизацию.
3. Дальше можно напрямую привязать automation outputs (`qa_summary`, `g1_eval`) к release gates и сайтовому monitoring.

## 5. Следующие шаги интеграции (приоритет)

1. Включить `run_daily_qa` и `build_g1_evidence_bundle` в CI/nightly pipeline как отдельный job `pilot-automation`.
   Статус: реализовано в GitHub Actions (`pilot-automation-smoke`) + добавлен отдельный holdout job (`release-gates-g1-holdout-smoke`) для проверки `G1/BENCH_G1` и `subgroup_max_mae_ratio`.
2. Добавить ingestion endpoint в Clinical Hub для приёма `qa_summary.json` и `g1_eval.json` (site/date/version).
   Статус: реализовано (`POST/GET /api/v1/pilot-automation-reports`, `GET /api/v1/pilot-automation-reports.csv`) + CLI-экспорт `export-pilot-automation-reports`.
   Дополнительно: `pilot-automation-smoke` может автоматически публиковать `qa_summary/tfl_summary/drift_summary/g1_eval/gate_summary` в Clinical Hub через `scripts/post_pilot_reports_to_clinical_hub.py` (если заданы `CLINICAL_HUB_URL` и `CLINICAL_HUB_API_KEY`).
3. Привязать `g1_eval` к существующему `evaluate-gates` (единый gate decision отчёт).
4. Добавить freeze registry (`dataset_id/model_id/qs_threshold`) с audit-логом изменения baseline.
5. Добавить операторский UI блок в mobile app для загрузки capture-package metadata (путь к файлам/manifest row).

Статус по п.3: реализован backfill в `build-gate-metrics` из `qa_summary/tfl_summary/drift_summary/g1_eval`.

## 6. Команды воспроизведения

Извлечение v2.5:

```bash
.venv/bin/python scripts/extract_project_package_v2_5.py \
  --zip-path "/Users/denecer/Yandex.Disk.localized/Научные материалы/Патентные заявки/Урофлоуметр/Uroflow_Project_Package_v2.5.zip" \
  --output-dir docs/project-package-v2.5 \
  --automation-out scripts/pilot_automation_v2_5
```

Smoke QA:

```bash
.venv/bin/python scripts/pilot_automation_v2_5/scripts/run_daily_qa.py \
  --dataset_root tmp/project-package-v2.5-source/Submission_Build_v2.5/10_Pilot_Automation/sample/sample_dataset_v1.1 \
  --manifest tmp/project-package-v2.5-source/Submission_Build_v2.5/10_Pilot_Automation/sample/sample_dataset_v1.1/manifest.csv \
  --out docs/project-package-v2.5/automation_smoke \
  --write_checksums
```

Smoke G1 bundle:

```bash
.venv/bin/python scripts/pilot_automation_v2_5/scripts/build_g1_evidence_bundle.py \
  --dataset_root tmp/project-package-v2.5-source/Submission_Build_v2.5/10_Pilot_Automation/sample/sample_dataset_v1.1 \
  --manifest tmp/project-package-v2.5-source/Submission_Build_v2.5/10_Pilot_Automation/sample/sample_dataset_v1.1/manifest.csv \
  --out_dir docs/project-package-v2.5/automation_smoke/g1 \
  --g1_config scripts/pilot_automation_v2_5/config/g1_acceptance_config.json
```

Gate-check по v2.5 порогам:

```bash
uroflow-mobile evaluate-gates /path/to/metrics.json \
  --config-json docs/project-package-v2.5/gates-config-v2.5.json \
  --gates G0 G1 BENCH_G0 BENCH_G1 BENCH_G2
```

Сборка `metrics.json` напрямую из automation-артефактов:

```bash
uroflow-mobile build-gate-metrics \
  --tfl-summary-json /path/to/tfl_summary.json \
  --drift-summary-json /path/to/drift_summary.json \
  --g1-eval-json /path/to/g1_eval.json \
  --qa-summary-json /path/to/qa_summary.json \
  --output-json /path/to/gate_metrics.json
```
