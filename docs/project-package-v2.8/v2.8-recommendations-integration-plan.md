# План интеграции Uroflow Project Package v2.8

Дата: 2026-02-24  
Источник: `Uroflow_Project_Package_v2.8.zip`

## 1. Что добавляет v2.8

Ключевое отличие от `v2.5`: пакет расширяет submission-ready контур автоматизациями по документационному evidence-loop:

1. `GSPR evidence autofill` (автопривязка доказательств).
2. `DHF status auto-update` по фактическому наличию артефактов.
3. `EU Annex II/III master index build` в исполняемом сценарии.
4. `G2 submission bundle` как отдельный automation-скрипт.
5. Обновлённые executed-реестры: `DHF v1.3`, `GSPR v1.3 evidence auto`, `EU Annex master index v1.1`.

## 2. Что интегрировано в репозиторий

### 2.1 Инвентаризация и извлечение структуры v2.8

Сформированы артефакты:

- `docs/project-package-v2.8/package_manifest_v2.8.csv`
- `docs/project-package-v2.8/module_summary_v2.8.csv`
- `docs/project-package-v2.8/docx_inventory_v2.8.csv`
- `docs/project-package-v2.8/xlsx_sheet_inventory_v2.8.csv`
- `docs/project-package-v2.8/sheets/` (извлечённые ключевые листы XLSX)
- `docs/project-package-v2.8/source_readme_v2.8.txt`

Итоги инвентаризации:

- всего файлов: **417**
- DOCX: **141**
- XLSX-sheet inventory rows: **369**
- извлечено automation-артефактов: **57**

### 2.2 Импорт pilot automation v2.8

Скрипты и конфиги вынесены в:

- `scripts/pilot_automation_v2_8/`

Импортировано:

- `scripts/` (daily QA, TFL, drift, G1 evidence + новые utility-скрипты для GSPR/DHF/EU index/G2 bundle),
- `config/` (QA, metrics, G1, G2, CSR, freeze),
- `schemas/`, one-click launcher scripts и README.

### 2.3 Исправления совместимости при интеграции

1. Обновлена численная интеграция для `numpy>=2.x`:
   - `scripts/pilot_automation_v2_8/scripts/uroflow_qa_utils.py`
   - `scripts/pilot_automation_v2_8/scripts/run_tfl_from_golden_dataset.py`
   - добавлен `np.trapezoid` с fallback на `np.trapz`.
2. Исправлен unit mismatch в G1-пороге:
   - `scripts/pilot_automation_v2_8/config/g1_acceptance_config.json`
   - `mape_vvoid_max: 0.15 -> 15.0`.
3. Vendor-исключение для линтинга:
   - `pyproject.toml` (`ruff.extend-exclude += scripts/pilot_automation_v2_8/scripts`).

### 2.4 Gate-конфиг по порогам v2.8

Добавлен отдельный gate-конфиг:

- `docs/project-package-v2.8/gates-config-v2.8.json`

Конфиг отражает acceptance пороги из `Uroflow_Acceptance_Test_Matrix_v1.0` в контексте сборки `Submission_Build_v2.8`.

## 3. GitHub Actions интеграция

Обновлён CI workflow:

- `pilot-automation-smoke` переключён на `scripts/pilot_automation_v2_8/...`;
- gate-check в smoke теперь идёт через `docs/project-package-v2.8/gates-config-v2.8.json`;
- публикация в Clinical Hub отправляет `package_version=v2.8`;
- добавлен шаг smoke-проверки новых utility-скриптов (`--help` для GSPR/DHF/EU/G2);
- `release-gates-g1-holdout-smoke` переведён на `gates-config-v2.8.json`.

## 4. Следующие шаги интеграции (приоритет)

1. Добавить отдельный CI job для full dry-run `GSPR/DHF/EU index/G2 bundle` на synthetic submission tree (не только `--help`).
2. Привязать выходы `update_dhf_status` и `build_eu_master_index` к Clinical Hub ingestion как отдельный тип отчётов.
3. Добавить nightly-автоматизацию по `dataset freeze` + подпись артефактов (checksums + immutable registry).
4. На pilot-площадке зафиксировать единый `submission_root` layout для кросс-скриптовых зависимостей.

## 5. Команды воспроизведения

Извлечение v2.8:

```bash
.venv/bin/python scripts/extract_project_package_v2_8.py \
  --zip-path "/Users/denecer/Yandex.Disk.localized/Научные материалы/Патентные заявки/Урофлоуметр/Uroflow_Project_Package_v2.8.zip" \
  --output-dir docs/project-package-v2.8 \
  --automation-out scripts/pilot_automation_v2_8
```

Smoke QA:

```bash
.venv/bin/python scripts/pilot_automation_v2_8/scripts/run_daily_qa.py \
  --dataset_root /path/to/sample_dataset_v1.1 \
  --manifest /path/to/sample_dataset_v1.1/manifest.csv \
  --config scripts/pilot_automation_v2_8/config/qa_config.json \
  --out docs/project-package-v2.8/automation_smoke \
  --write_checksums
```

Gate-check по v2.8 порогам:

```bash
uroflow-mobile evaluate-gates /path/to/metrics.json \
  --config-json docs/project-package-v2.8/gates-config-v2.8.json \
  --gates G0 G1 BENCH_G0 BENCH_G1 BENCH_G2
```
