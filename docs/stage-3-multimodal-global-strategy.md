# Этап 3 (концепт): Мультимодальный смартфон-урофлоуметр и глобальная стратегия (RU/CN/EU/US)

Источник концепта: сообщение пользователя от `2026-02-23` (мультимодальность: камера + микрофон + LiDAR/TrueDepth).

## 1) Целевой выход системы

Обязательный минимум:
- `Qmax`, `Qavg`, `Vvoid`
- `Flow time`, `Voiding time`, `TQmax`
- классификация формы `Q(t)` и индекс интермиттирующести

Желательные дополнительные метрики:
- индекс нестабильности потока
- детекция эпизодов прерываний/подтекания
- интегральный `quality score` измерения

Вне прямого измерения смартфоном без внешнего датчика:
- `PVR` (остаточная моча)

## 2) Базовый физический подход

Цель: построить устойчивую оценку `Q(t)` из непрямых каналов.

Опоры измерения:
1. акустика удара струи;
2. видео-анализ событий в зоне воды;
3. геометрическая нормализация (`LiDAR/TrueDepth` + AR-ориентиры).

Ключевой принцип:
- depth используется прежде всего для геометрии/нормализации и контроля качества,
  а не как единственный прямой сенсор уровня воды.

## 3) Три режима измерения

### A. Universal Water-Impact Mode (главный)
- Каналы: аудио + видео ROI воды + depth-геометрия
- Подходит для мужчин и женщин
- Основной режим клинически применимого MVP

### B. Male Jet-in-Air Mode (опциональный)
- Каналы: видео струи в воздухе + depth + IMU + аудио
- Используется как усилитель уверенности, а не как единственный источник истины

### C. Porcelain/Wall Mode (fallback)
- Каналы: преимущественно аудио + отдельная модель домена
- Нужен как деградированный сценарий, если поток не в воду

## 4) UX без насадок

Обязательные элементы:
- AR-мастер позиционирования телефона
- автоматическая проверка геометрии/света/видимости ROI
- приватность по умолчанию: анализ только ROI воды

Сценарии позы:
- мужчины: чаще standing, установка сбоку/сзади
- женщины: чаще sitting, основной канал — звук + видео воды

## 5) Sensor Fusion Pipeline

1. Детекция начала/конца акта:
   audio-onset + video ROI-change + устойчивость по времени.
2. Извлечение признаков:
   - аудио: спектральные и турбулентные признаки;
   - видео: optical-flow, splash/ripple индексы;
   - depth/геометрия: расстояние, угол, устойчивость ROI.
3. Модель оценки `Q(t)`:
   - либо late-fusion нейросеть;
   - либо байесовское объединение `Q_a(t)` и `Q_v(t)` с весами по uncertainty.
4. Физические ограничения:
   - `Q(t) >= 0`
   - ограничение резких скачков
   - устойчивый интеграл по объёму

## 6) Калибровка без аксессуаров

Двухконтурная схема:
1. Геометрическая калибровка (обязательная):
   AR/LiDAR фиксация ракурса, дистанции и ROI.
2. Опциональная pour-калибровка:
   тестовый пролив известного объёма (например, 300-500 мл)
   для адаптации под конкретный туалет/акустику.

## 7) Качество измерения (ICS-style mindset)

Системе нужны:
- артефакт-детектор (ROI потерян, движение телефона, плохая геометрия)
- статус интерпретации: `valid/repeat/reject`
- правила повторения при нерепрезентативном объёме
- поддержка многократных измерений и трендов

## 8) Архитектура iOS-продукта

### On-device по умолчанию
- захват аудио/видео/depth
- извлечение признаков и inference локально (CoreML)
- экспорт на сервер только метрик/кривых/quality (без raw-медиа по умолчанию)

### Клинический режим
- отдельное согласие
- экспорт: PDF + FHIR/HL7

## 9) Регуляторная рамка по регионам

### США
- ориентир: `Urine flow or volume measuring system` как медизделие
- учитывать software + AI/ML + cyber obligations

### ЕС
- MDR и Rule 11 для standalone software
- вероятный базовый класс не ниже IIa при диагностической информации

### Китай
- NMPA standalone medical software рамка
- измерительные функции обычно не ниже Class II (по intended use)

### Россия
- регистрация по актуальным правилам Росздравнадзора
- ранняя фиксация класса риска и intended use для ПО

## 10) Данные и приватность по регионам

### ЕС
- special category (health data), strict lawful basis and consent logic

### Китай
- sensitive personal information и отдельное согласие

### Россия
- строгая локализация ПД граждан РФ
- приоритет on-device или инфраструктура в РФ

### США
- HIPAA-контур для клинических интеграций (при работе с covered entities / BAA)

## 11) План валидации

1. Лабораторный стенд:
   известные профили расхода и карта ошибок.
2. Клиническая парная валидация:
   сравнение с эталонным урофлоуметром, Bland-Altman + repeatability.
3. Домашний real-world:
   устойчивость, quality-gating, доля валидных записей.

## 12) Ключевые риски и mitigations

- шум среды -> мультимодальная проверка + шумоподавление
- вариативность туалетов -> геометрия + адаптивная калибровка
- ограниченность depth на воде -> depth как геометрия, не основной уровень
- приватность -> ROI-only и derivatives-first
- клинический риск неверной кривой -> quality score + обязательные правила повторения

## 13) Патентные якоря

- fusion-алгоритм с физическими ограничениями и uncertainty
- toilet-fingerprinting и адаптация под среду
- quality-scoring как медицинский контроль артефактов
- privacy-preserving pipeline (on-device features + metrics-only export)

## 14) Практичный поэтапный план

1. MVP fast track: audio-first + start/stop + базовый quality.
2. v1 clinical: audio + water-ROI video + quality score + report export.
3. v2 Pro: LiDAR/TrueDepth геометрия и улучшенная нормализация.
4. v3: longitudinal monitoring + EMR/FHIR/HL7 + региональные облачные контуры.

## Реализация в репозитории

Текущая реализация synthetic-bench и iOS capture contract описана в:
`docs/stage-3-synthetic-bench-and-ios-contract.md`.
